name: CI - Validation and Testing

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ develop, feature/* ]

jobs:
  validate-pbip:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Validate PBIP structure
        run: |
          echo "ğŸ” Validating PBIP project structure..."
          
          # Verificar que existan archivos .pbir
          if ls *.pbir 1> /dev/null 2>&1; then
            echo "âœ… Found .pbir files"
            ls -la *.pbir
          else
            echo "âŒ No .pbir files found"
            exit 1
          fi
          
          # Verificar estructura de carpetas
          echo "ğŸ“ Checking folder structure..."
          if [ -d "definition" ]; then
            echo "âœ… Definition folder exists"
          else
            echo "âŒ Definition folder missing"
            exit 1
          fi
          
          echo "âœ… PBIP structure validation completed successfully"
          
      - name: Check JSON syntax
        run: |
          echo "ğŸ” Validating JSON files..."
          
          # Buscar y validar archivos JSON
          find . -name "*.json" -type f | while read file; do
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "âœ… $file is valid JSON"
            else
              echo "âŒ $file has invalid JSON syntax"
              exit 1
            fi
          done
          
          echo "âœ… All JSON files are valid"
          
      - name: Security scan
        run: |
          echo "ğŸ”’ Running security checks..."
          
          # Verificar que no haya credenciales hardcodeadas
          if grep -r -i "password\|secret\|key" --include="*.json" --include="*.pbir" . | grep -v ".git"; then
            echo "âš ï¸ Potential credentials found in files"
            echo "Please review and remove any hardcoded credentials"
            exit 1
          else
            echo "âœ… No hardcoded credentials detected"
          fi
          
      - name: Report validation results
        run: |
          echo "ğŸ“Š Validation Summary:"
          echo "âœ… PBIP structure: Valid"
          echo "âœ… JSON syntax: Valid"
          echo "âœ… Security scan: Passed"
          echo "ğŸ‰ Ready for deployment!"